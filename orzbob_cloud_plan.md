# Orzbob Cloud – Engineering Blueprint (v0.9)

> **Purpose**  
> A complete, self‑contained guide that an implementation team (or coding agent) can consume to turn the local‑only **orzbob** project into a production‑ready, multi‑tenant SaaS offering.

---

## Table of Contents
1. [Background & Goals](#background--goals)  
2. [High‑Level Architecture](#high-level-architecture)  
3. [Lean SaaS MVP Functional Spec](#lean-saas-mvp-functional-spec)  
4. [Developer Environment Boot‑Strap](#developer-environment-boot-strap)  
5. [Secrets & Security (MVP)](#secrets--security-mvp)  
6. [Detailed Component Design](#detailed-component-design)  
7. [Repository Restructure](#repository-restructure)  
8. [Infrastructure‑as‑Code](#infrastructure-as-code)  
9. [CI/CD Pipeline](#cicd-pipeline)  
10. [Quality Gates & SLOs](#quality-gates--slos)  
11. [Milestone Schedule](#milestone-schedule)  
12. [Risk Register](#risk-register)  
13. [Command Reference](#command-reference)  

---

## Background & Goals

| ID | Goal | Rationale |
|----|------|-----------|
| G‑1 | **Hosted "remote runner"** that mirrors the current local worktree + tmux flow | Developers retain familiar UX while unlocking elastic compute |
| G‑2 | **Zero‑setup onboarding** (GitHub OAuth, single region) | < 5 min from signup to first run |
| G‑3 | **Multi‑tenant isolation** with audited access | Multiple companies share one control plane safely |
| G‑4 | **Scalable & cost‑aware** | Hundreds of parallel sessions, idle reaper, tiered pricing |
| G‑5 | **Declarative per‑project env** & side‑car DBs | Reproducible builds/tests inside each runner |

---

## High‑Level Architecture

```mermaid
flowchart LR
subgraph Client
  CLI["orz CLI"] -->|HTTPS (JWT)| API
end
subgraph ControlPlane
  API["API Gateway  
(gRPC + REST)"]
  API --> Auth
  Auth --> Scheduler
  Scheduler -->|K8s CRD| k8s[(EKS Cluster)]
  API --> Tunnel
end
k8s -->|Pod / PVC| Runner["Runner Pod
(main + sidecars)"]
CLI -. wss attach .-> Tunnel["WebSocket ↔ SSH proxy"]
```

*Single AWS EKS cluster (`us‑east‑2`), EFS for persistent volumes.*

---

## Lean SaaS MVP Functional Spec

### 1. Runner Tiers

| Flag `--tier` | vCPU | RAM | Lifetime | Notes |
|---------------|------|-----|----------|-------|
| `small` (default) | 2 | 4 Gi | 6 h | Free & Pro |
| `medium` | 4 | 8 Gi | 6 h | Pro |
| `gpu` | 1×A10G | 24 Gi | 3 h | GPU plan |

### 2. Public API (excerpt)

```yaml
POST /v1/instances                 # create
GET  /v1/instances/{id}            # inspect
POST /v1/instances/{id}/attach     # signed ws URL
DELETE /v1/instances/{id}          # terminate
```

Authentication: GitHub OAuth bearer (`Authorization: Bearer <token>`)

### 3. CLI Workflow

```bash
orz login                # GitHub OAuth
orz n -p "claude"        # cloud runner spin‑up
orz attach               # connect via tunnel
orz secrets set DB pass  # stores encrypted secret
```

---

## Developer Environment Boot‑Strap

`.orz/cloud.yaml` *(generated by `orz devenv init`)*

```yaml
setup:
  init:
    - go mod download
    - make db-prepare
  onAttach:
    - make migrate
services:
  postgres:
    image: postgres:15-alpine
    env: { POSTGRES_PASSWORD: pass }
  redis:
    image: redis:7-alpine
env:
  DATABASE_URL: postgres://postgres:pass@localhost:5432/postgres
cacheDirs:
  - ~/.cache/go-build
```

Runner pod assembly logic:

* **Init container** → executes `init` once, mounts cache PVC  
* **Sidecars** → one container per `services` entry  
* **Lifecycle postStart** → runs `onAttach` every connect

---

## Secrets & Security (MVP)

| Concern | Solution |
|---------|----------|
| Storage | Kubernetes Secrets (`org‑<id>` namespace) encrypted with AWS KMS‑etcd |
| Injection | `envFrom:` in main & sidecars |
| Rotation | GitHub tokens auto‑refresh; user secrets via `orz secrets set` |
| Ingress | No public SSH. Attach uses signed WebSocket through API gateway |
| Isolation | Pod SecurityContext, NetworkPolicy (egress allow GitHub + SaaS API) |

---

## Detailed Component Design

### 1. Control‑Plane (`cmd/cloud-cp`)

* **Stack:** Go 1.23, chi, grpc‑gateway, client‑go 0.29  
* **Key modules**  
  * `auth/github.go` – verifies JWT, pulls org info  
  * `scheduler/pod.go` – builds pod spec from tier & YAML  
  * `tunnel/wsproxy.go` – STDIO mux, issues 2‑min ES256 JWT  
  * `reaper/idle.go` – deletes pods `idle > 30 min`

### 2. Runner Agent (`cmd/cloud-agent`)

```go
func main() {
  bootstrap()
  runInit()
  startSidecars()
  launchTmux(os.Args[1:])
  heartbeat()
}
```

* Publishes `/workspace/.orz/scripts/...` exit codes back to cp  
* Uses existing `session` & `tmux` packages

### 3. Database

* Postgres 15 (AWS RDS) stores: `users`, `orgs`, `instances`, `usage`

---

## Repository Restructure

```
orzbob/
├── cmd/
│   ├── orz/            # CLI
│   ├── cloud-cp/       # control‑plane
│   └── cloud-agent/    # runner
├── internal/
│   ├── cloud/api       # protobuf
│   ├── scheduler
│   ├── tunnel
│   └── secrets
├── charts/             # Helm charts
└── docker/
    ├── runner.Dockerfile
    └── cp.Dockerfile
```

---

## Infrastructure‑as‑Code

Terraform module (`infra/`):

```hcl
module "eks" { source = "terraform-aws-modules/eks/aws"
  cluster_version = "1.29"
  enable_irsa     = true
  addons          = ["vpc-cni", "coredns", "efs-csi-driver"]
}

resource "aws_efs_file_system" "workspace" { encrypted = true }

resource "aws_kms_key" "etcd" { description = "Encrypt EKS etcd" }
```

Helm release managed by Argo CD (`applicationset.yaml`).

---

## CI/CD Pipeline

* **GitHub Actions** (`.github/workflows/build.yml`)
  * Matrix build: `component=[cli,cp,runner]`
  * Push OCI images → `ghcr.io/orzbob/{component}:$GITHUB_SHA`
* **tests**
  * `go test ./...`
  * Kind‑based integration: create cp, fake provider, assert attach
* **Helm lint & diff**

---

## Quality Gates & SLOs

| Metric | Target |
|--------|--------|
| API P99 latency | < 200 ms |
| Runner Ready time | < 45 s (small tier) |
| 5xx error rate | < 0.1 % / day |
| Mean time to idle terminate | ≤ 35 min |

---

## Milestone Schedule

| Sprint (1 wk) | Deliverables |
|---------------|--------------|
| **S1** | API proto, CLI scaffold, fake provider |
| **S2** | Runner pod boots repo & tmux; local attach |
| **S3** | EKS deploy, WebSocket tunnel, idle reaper |
| **S4** | Secrets CRUD, quota checks, Prometheus |
| **S5** | Docs, Helm chart, free‑tier GA |

---

## Risk Register

| Risk | Impact | Mitigation |
|------|--------|------------|
| K8s API changes | High | Pin client‑go, nightly e2e |
| GitHub rate limits | Medium | Shared token cache, back‑off |
| Secret leaks in logs | High | Redact env in cp logs, CI `gitleaks` |

---

## Command Reference

| Command | Action |
|---------|--------|
| `orz login` | GitHub OAuth flow |
| `orz cloud new -p "aider"` | Spin remote runner |
| `orz attach` | Connect via WebSocket tunnel |
| `orz list` | List local + cloud sessions |
| `orz secrets set KEY VALUE` | Store encrypted secret |

---

**End of Document**

*License: original project under AGPL‑3.0*  

---